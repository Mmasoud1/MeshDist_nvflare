2024-09-19 16:26:09,059 - SimulatorRunner - INFO - Create the Simulator Server.
2024-09-19 16:26:09,063 - CoreCell - INFO - server: creating listener on tcp://0:48267
2024-09-19 16:26:09,088 - CoreCell - INFO - server: created backbone external listener for tcp://0:48267
2024-09-19 16:26:09,088 - ConnectorManager - INFO - 10891: Try start_listener Listener resources: {'secure': False, 'host': 'localhost'}
2024-09-19 16:26:09,089 - nvflare.fuel.f3.sfm.conn_manager - INFO - Connector [CH00002 PASSIVE tcp://0:14483] is starting
2024-09-19 16:26:09,590 - CoreCell - INFO - server: created backbone internal listener for tcp://localhost:14483
2024-09-19 16:26:09,590 - nvflare.fuel.f3.sfm.conn_manager - INFO - Connector [CH00001 PASSIVE tcp://0:48267] is starting
2024-09-19 16:26:09,713 - nvflare.fuel.hci.server.hci - INFO - Starting Admin Server localhost on Port 59141
2024-09-19 16:26:09,714 - SimulatorRunner - INFO - Deploy the Apps.
2024-09-19 16:26:09,747 - SimulatorRunner - INFO - Create the simulate clients.
2024-09-19 16:26:09,752 - ClientManager - INFO - Client: New client site-1@192.168.0.105 joined. Sent token: 56e454fc-492e-45a5-bf30-2b5d30b1c1d8.  Total clients: 1
2024-09-19 16:26:09,752 - FederatedClient - INFO - Successfully registered client:site-1 for project simulator_server. Token:56e454fc-492e-45a5-bf30-2b5d30b1c1d8 SSID:
2024-09-19 16:26:09,753 - ClientManager - INFO - Client: New client site-2@192.168.0.105 joined. Sent token: a1fc4951-819b-47a0-a9ef-b9ccba401f84.  Total clients: 2
2024-09-19 16:26:09,754 - FederatedClient - INFO - Successfully registered client:site-2 for project simulator_server. Token:a1fc4951-819b-47a0-a9ef-b9ccba401f84 SSID:
2024-09-19 16:26:09,754 - SimulatorRunner - INFO - Set the client status ready.
2024-09-19 16:26:09,754 - SimulatorRunner - INFO - Deploy and start the Server App.
2024-09-19 16:26:09,755 - Cell - INFO - Register blob CB for channel='server_command', topic='*'
2024-09-19 16:26:09,755 - Cell - INFO - Register blob CB for channel='aux_communication', topic='*'
2024-09-19 16:26:09,755 - ServerCommandAgent - INFO - ServerCommandAgent cell register_request_cb: server.simulate_job
2024-09-19 16:26:11,918 - numexpr.utils - INFO - Note: NumExpr detected 12 cores but "NUMEXPR_MAX_THREADS" not set, so enforcing safe limit of 8.
2024-09-19 16:26:11,918 - numexpr.utils - INFO - NumExpr defaulting to 8 threads.
2024-09-19 16:26:13,878 - ServerRunner - INFO - [identity=simulator_server, run=simulate_job]: Server runner starting ...
2024-09-19 16:26:13,879 - ServerRunner - INFO - [identity=simulator_server, run=simulate_job]: starting workflow gradient_aggregation_workflow (<class 'workflow.gradient_aggregation_workflow.GradientAggregationWorkflow'>) ...
2024-09-19 16:26:13,879 - ServerRunner - INFO - [identity=simulator_server, run=simulate_job, wf=gradient_aggregation_workflow]: Workflow gradient_aggregation_workflow (<class 'workflow.gradient_aggregation_workflow.GradientAggregationWorkflow'>) started
2024-09-19 16:26:13,879 - GradientAggregationWorkflow - INFO - [identity=simulator_server, run=simulate_job, wf=gradient_aggregation_workflow]: scheduled task train_and_get_gradients
2024-09-19 16:26:14,765 - SimulatorClientRunner - INFO - Start the clients run simulation.
2024-09-19 16:26:15,766 - SimulatorClientRunner - INFO - Simulate Run client: site-1 on GPU group: None
2024-09-19 16:26:15,766 - SimulatorClientRunner - INFO - Simulate Run client: site-2 on GPU group: None
2024-09-19 16:26:16,913 - nvflare.fuel.f3.sfm.conn_manager - INFO - Connection [CN00005 127.0.0.1:48267 <= 127.0.0.1:56258] is created: PID: 10891
2024-09-19 16:26:16,914 - nvflare.fuel.f3.sfm.conn_manager - INFO - Connection [CN00006 127.0.0.1:48267 <= 127.0.0.1:56262] is created: PID: 10891
2024-09-19 16:26:24,403 - ServerRunner - INFO - [identity=simulator_server, run=simulate_job, wf=gradient_aggregation_workflow, peer=site-2, peer_run=simulate_job, task_name=train_and_get_gradients, task_id=cea3d6ef-f637-410f-b6eb-0e43c3af1dda]: assigned task to client site-2: name=train_and_get_gradients, id=cea3d6ef-f637-410f-b6eb-0e43c3af1dda
2024-09-19 16:26:24,403 - ServerRunner - INFO - [identity=simulator_server, run=simulate_job, wf=gradient_aggregation_workflow, peer=site-2, peer_run=simulate_job, task_name=train_and_get_gradients, task_id=cea3d6ef-f637-410f-b6eb-0e43c3af1dda]: sent task assignment to client. client_name:site-2 task_id:cea3d6ef-f637-410f-b6eb-0e43c3af1dda
2024-09-19 16:26:24,404 - GetTaskCommand - INFO - return task to client.  client_name: site-2  task_name: train_and_get_gradients   task_id: cea3d6ef-f637-410f-b6eb-0e43c3af1dda  sharable_header_task_id: cea3d6ef-f637-410f-b6eb-0e43c3af1dda
2024-09-19 16:26:24,406 - ServerRunner - INFO - [identity=simulator_server, run=simulate_job, wf=gradient_aggregation_workflow, peer=site-1, peer_run=simulate_job, task_name=train_and_get_gradients, task_id=de6f9a8e-348f-4bb9-ae1d-ccf5c9f6385f]: assigned task to client site-1: name=train_and_get_gradients, id=de6f9a8e-348f-4bb9-ae1d-ccf5c9f6385f
2024-09-19 16:26:24,407 - ServerRunner - INFO - [identity=simulator_server, run=simulate_job, wf=gradient_aggregation_workflow, peer=site-1, peer_run=simulate_job, task_name=train_and_get_gradients, task_id=de6f9a8e-348f-4bb9-ae1d-ccf5c9f6385f]: sent task assignment to client. client_name:site-1 task_id:de6f9a8e-348f-4bb9-ae1d-ccf5c9f6385f
2024-09-19 16:26:24,407 - GetTaskCommand - INFO - return task to client.  client_name: site-1  task_name: train_and_get_gradients   task_id: de6f9a8e-348f-4bb9-ae1d-ccf5c9f6385f  sharable_header_task_id: de6f9a8e-348f-4bb9-ae1d-ccf5c9f6385f
2024-09-19 16:26:27,187 - ServerRunner - INFO - [identity=simulator_server, run=simulate_job, wf=gradient_aggregation_workflow, peer=site-2, peer_run=simulate_job]: got result from client site-2 for task: name=train_and_get_gradients, id=cea3d6ef-f637-410f-b6eb-0e43c3af1dda
2024-09-19 16:26:27,187 - GradientAggregationWorkflow - ERROR - [identity=simulator_server, run=simulate_job, wf=gradient_aggregation_workflow, peer=site-2, peer_run=simulate_job, peer_rc=EXECUTION_RESULT_ERROR, task_name=train_and_get_gradients, task_id=cea3d6ef-f637-410f-b6eb-0e43c3af1dda]: processing error in result_received_cb on task train_and_get_gradients(cea3d6ef-f637-410f-b6eb-0e43c3af1dda): KeyError: 'gradients'
2024-09-19 16:26:27,198 - GradientAggregationWorkflow - ERROR - Traceback (most recent call last):
  File "/home/mohamed/anaconda3/lib/python3.8/site-packages/nvflare/apis/impl/controller.py", line 424, in _do_process_submission
    task.result_received_cb(client_task=client_task, fl_ctx=fl_ctx)
  File "/media/mohamed/3563bb56-889a-4bad-a486-da7f2f0b6a03/MyGithub/Coinstac_all/MeshDist_nvflare/app/code/workflow/gradient_aggregation_workflow.py", line 84, in _accept_site_result
    accepted = self.aggregator.accept(client_task.result, fl_ctx)
  File "/media/mohamed/3563bb56-889a-4bad-a486-da7f2f0b6a03/MyGithub/Coinstac_all/MeshDist_nvflare/app/code/aggregator/gradient_aggregator.py", line 13, in accept
    gradients = shareable["gradients"]
KeyError: 'gradients'

2024-09-19 16:26:27,199 - ServerRunner - INFO - [identity=simulator_server, run=simulate_job, wf=gradient_aggregation_workflow, peer=site-2, peer_run=simulate_job, peer_rc=EXECUTION_RESULT_ERROR, task_name=train_and_get_gradients, task_id=cea3d6ef-f637-410f-b6eb-0e43c3af1dda]: finished processing client result by gradient_aggregation_workflow
2024-09-19 16:26:27,199 - SubmitUpdateCommand - INFO - submit_update process. client_name:site-2   task_id:cea3d6ef-f637-410f-b6eb-0e43c3af1dda
2024-09-19 16:26:27,360 - ServerRunner - INFO - [identity=simulator_server, run=simulate_job, wf=gradient_aggregation_workflow, peer=site-1, peer_run=simulate_job]: got result from client site-1 for task: name=train_and_get_gradients, id=de6f9a8e-348f-4bb9-ae1d-ccf5c9f6385f
2024-09-19 16:26:27,361 - GradientAggregationWorkflow - INFO - [identity=simulator_server, run=simulate_job, wf=gradient_aggregation_workflow, peer=site-1, peer_run=simulate_job, peer_rc=EXECUTION_RESULT_ERROR, task_name=train_and_get_gradients, task_id=de6f9a8e-348f-4bb9-ae1d-ccf5c9f6385f]: task is already finished - submission dropped
2024-09-19 16:26:27,361 - ServerRunner - INFO - [identity=simulator_server, run=simulate_job, wf=gradient_aggregation_workflow, peer=site-1, peer_run=simulate_job, peer_rc=EXECUTION_RESULT_ERROR, task_name=train_and_get_gradients, task_id=de6f9a8e-348f-4bb9-ae1d-ccf5c9f6385f]: finished processing client result by gradient_aggregation_workflow
2024-09-19 16:26:27,361 - SubmitUpdateCommand - INFO - submit_update process. client_name:site-1   task_id:de6f9a8e-348f-4bb9-ae1d-ccf5c9f6385f
2024-09-19 16:26:27,398 - GradientAggregationWorkflow - INFO - [identity=simulator_server, run=simulate_job, wf=gradient_aggregation_workflow]: task train_and_get_gradients exit with status TaskCompletionStatus.ERROR
2024-09-19 16:26:27,398 - GradientAggregationWorkflow - INFO - [identity=simulator_server, run=simulate_job, wf=gradient_aggregation_workflow]: Start gradient aggregation.
2024-09-19 16:26:27,399 - ServerRunner - ERROR - [identity=simulator_server, run=simulate_job, wf=gradient_aggregation_workflow]: Exception in workflow gradient_aggregation_workflow: IndexError: list index out of range
2024-09-19 16:26:27,400 - ServerRunner - ERROR - Traceback (most recent call last):
  File "/home/mohamed/anaconda3/lib/python3.8/site-packages/nvflare/private/fed/server/server_runner.py", line 140, in _execute_run
    wf.responder.control_flow(self.abort_signal, fl_ctx)
  File "/media/mohamed/3563bb56-889a-4bad-a486-da7f2f0b6a03/MyGithub/Coinstac_all/MeshDist_nvflare/app/code/workflow/gradient_aggregation_workflow.py", line 62, in control_flow
    aggregated_shareable = self.aggregator.aggregate(fl_ctx)
  File "/media/mohamed/3563bb56-889a-4bad-a486-da7f2f0b6a03/MyGithub/Coinstac_all/MeshDist_nvflare/app/code/aggregator/gradient_aggregator.py", line 19, in aggregate
    aggregated_gradients = self.average_gradients(self.gradients_list)
  File "/media/mohamed/3563bb56-889a-4bad-a486-da7f2f0b6a03/MyGithub/Coinstac_all/MeshDist_nvflare/app/code/aggregator/gradient_aggregator.py", line 32, in average_gradients
    sum_arrays = [np.zeros_like(arr) for arr in gradients_list[0]]
IndexError: list index out of range

2024-09-19 16:26:27,400 - ServerRunner - ERROR - [identity=simulator_server, run=simulate_job, wf=gradient_aggregation_workflow]: Aborting current RUN due to FATAL_SYSTEM_ERROR received: Exception in workflow gradient_aggregation_workflow: IndexError: list index out of range
2024-09-19 16:26:27,401 - ServerRunner - INFO - [identity=simulator_server, run=simulate_job, wf=gradient_aggregation_workflow]: asked to abort - triggered abort_signal to stop the RUN
2024-09-19 16:26:27,401 - ServerRunner - INFO - [identity=simulator_server, run=simulate_job, wf=gradient_aggregation_workflow]: Workflow: gradient_aggregation_workflow finalizing ...
2024-09-19 16:26:27,900 - ServerRunner - INFO - [identity=simulator_server, run=simulate_job, wf=gradient_aggregation_workflow]: ABOUT_TO_END_RUN fired
2024-09-19 16:26:27,900 - ServerRunner - INFO - [identity=simulator_server, run=simulate_job, wf=gradient_aggregation_workflow]: Firing CHECK_END_RUN_READINESS ...
2024-09-19 16:26:27,900 - ServerRunner - INFO - [identity=simulator_server, run=simulate_job, wf=gradient_aggregation_workflow]: END_RUN fired
2024-09-19 16:26:27,901 - ServerRunner - INFO - [identity=simulator_server, run=simulate_job, wf=gradient_aggregation_workflow]: Server runner finished.
2024-09-19 16:26:28,893 - SimulatorServer - INFO - Server app stopped.


2024-09-19 16:26:28,902 - nvflare.fuel.hci.server.hci - INFO - Admin Server localhost on Port 59141 shutdown!
2024-09-19 16:26:28,902 - SimulatorServer - INFO - shutting down server
2024-09-19 16:26:28,903 - SimulatorServer - INFO - canceling sync locks
2024-09-19 16:26:28,903 - SimulatorServer - INFO - server off
2024-09-19 16:26:29,208 - ServerRunner - INFO - [identity=simulator_server, run=simulate_job, wf=gradient_aggregation_workflow, peer=site-2, peer_run=simulate_job]: server runner is finalizing - asked client to end the run
2024-09-19 16:26:29,208 - GetTaskCommand - INFO - return task to client.  client_name: site-2  task_name: __end_run__   task_id:   sharable_header_task_id: 
2024-09-19 16:26:29,256 - nvflare.fuel.f3.sfm.conn_manager - INFO - Connection [CN00006 Not Connected] is closed PID: 10891
2024-09-19 16:26:29,369 - ServerRunner - INFO - [identity=simulator_server, run=simulate_job, wf=gradient_aggregation_workflow, peer=site-1, peer_run=simulate_job]: server runner is finalizing - asked client to end the run
2024-09-19 16:26:29,370 - GetTaskCommand - INFO - return task to client.  client_name: site-1  task_name: __end_run__   task_id:   sharable_header_task_id: 
2024-09-19 16:26:29,418 - FederatedClient - INFO - Shutting down client run: site-1
2024-09-19 16:26:29,419 - FederatedClient - INFO - Shutting down client run: site-2
2024-09-19 16:26:29,420 - ServerRunner - INFO - [identity=simulator_server, run=simulate_job, wf=gradient_aggregation_workflow]: asked to abort - triggered abort_signal to stop the RUN
2024-09-19 16:26:29,421 - nvflare.fuel.f3.sfm.conn_manager - INFO - Connection [CN00005 Not Connected] is closed PID: 10891
2024-09-19 16:26:32,911 - MPM - INFO - MPM: Good Bye!
