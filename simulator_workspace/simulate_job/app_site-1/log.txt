2024-09-19 16:26:16,813 - ClientTaskWorker - INFO - ClientTaskWorker started to run
2024-09-19 16:26:16,911 - CoreCell - INFO - site-1.simulate_job: created backbone external connector to tcp://localhost:48267
2024-09-19 16:26:16,911 - nvflare.fuel.f3.sfm.conn_manager - INFO - Connector [CH00001 ACTIVE tcp://localhost:48267] is starting
2024-09-19 16:26:16,912 - nvflare.fuel.f3.sfm.conn_manager - INFO - Connection [CN00002 127.0.0.1:56258 => 127.0.0.1:48267] is created: PID: 10921
2024-09-19 16:26:19,046 - numexpr.utils - INFO - Note: NumExpr detected 12 cores but "NUMEXPR_MAX_THREADS" not set, so enforcing safe limit of 8.
2024-09-19 16:26:19,046 - numexpr.utils - INFO - NumExpr defaulting to 8 threads.
2024-09-19 16:26:23,894 - Cell - INFO - Register blob CB for channel='aux_communication', topic='*'
2024-09-19 16:26:24,399 - Cell - INFO - broadcast: channel='aux_communication', topic='__sync_runner__', targets=['server.simulate_job'], timeout=2.0
2024-09-19 16:26:24,403 - ClientRunner - INFO - [identity=site-1, run=simulate_job]: synced to Server Runner in 0.5040366649627686 seconds
2024-09-19 16:26:24,403 - ClientRunner - INFO - [identity=site-1, run=simulate_job]: client runner started
2024-09-19 16:26:24,403 - ClientTaskWorker - INFO - Initialize ClientRunner for client: site-1
2024-09-19 16:26:24,409 - Communicator - INFO - Received from simulator_server server. getTask: train_and_get_gradients size: 518B (518 Bytes) time: 0.006004 seconds
2024-09-19 16:26:24,410 - FederatedClient - INFO - pull_task completed. Task name:train_and_get_gradients Status:True 
2024-09-19 16:26:24,410 - ClientRunner - INFO - [identity=site-1, run=simulate_job, peer=simulator_server, peer_run=simulate_job]: got task assignment: name=train_and_get_gradients, id=de6f9a8e-348f-4bb9-ae1d-ccf5c9f6385f
2024-09-19 16:26:24,410 - ClientRunner - INFO - [identity=site-1, run=simulate_job, peer=simulator_server, peer_run=simulate_job, task_name=train_and_get_gradients, task_id=de6f9a8e-348f-4bb9-ae1d-ccf5c9f6385f]: invoking task executor MeshNetExecutor
2024-09-19 16:26:27,345 - ClientRunner - ERROR - [identity=site-1, run=simulate_job, peer=simulator_server, peer_run=simulate_job, task_name=train_and_get_gradients, task_id=de6f9a8e-348f-4bb9-ae1d-ccf5c9f6385f]: RuntimeError from executor MeshNetExecutor: OutOfMemoryError: CUDA out of memory. Tried to allocate 320.00 MiB. GPU 0 has a total capacity of 3.94 GiB of which 307.25 MiB is free. Including non-PyTorch memory, this process has 516.00 MiB memory in use. Process 10920 has 2.07 GiB memory in use. Of the allocated memory 448.05 MiB is allocated by PyTorch, and 13.95 MiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True to avoid fragmentation.  See documentation for Memory Management  (https://pytorch.org/docs/stable/notes/cuda.html#environment-variables): Aborting the job!
2024-09-19 16:26:27,347 - ClientRunner - ERROR - Traceback (most recent call last):
  File "/home/mohamed/anaconda3/lib/python3.8/site-packages/nvflare/private/fed/client/client_runner.py", line 301, in _do_process_task
    reply = executor.execute(task.name, task.data, fl_ctx, abort_signal)
  File "/media/mohamed/3563bb56-889a-4bad-a486-da7f2f0b6a03/MyGithub/Coinstac_all/MeshDist_nvflare/app/code/executor/meshnet_executor.py", line 51, in execute
    gradients = self.train_and_get_gradients()
  File "/media/mohamed/3563bb56-889a-4bad-a486-da7f2f0b6a03/MyGithub/Coinstac_all/MeshDist_nvflare/app/code/executor/meshnet_executor.py", line 71, in train_and_get_gradients
    output = self.model(image)
  File "/home/mohamed/anaconda3/lib/python3.8/site-packages/torch/nn/modules/module.py", line 1553, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/home/mohamed/anaconda3/lib/python3.8/site-packages/torch/nn/modules/module.py", line 1562, in _call_impl
    return forward_call(*args, **kwargs)
  File "/media/mohamed/3563bb56-889a-4bad-a486-da7f2f0b6a03/MyGithub/Coinstac_all/MeshDist_nvflare/app/code/executor/meshnet.py", line 114, in forward
    return self.train_forward(x)
  File "/media/mohamed/3563bb56-889a-4bad-a486-da7f2f0b6a03/MyGithub/Coinstac_all/MeshDist_nvflare/app/code/executor/meshnet.py", line 100, in train_forward
    y = checkpoint_sequential(
  File "/home/mohamed/anaconda3/lib/python3.8/site-packages/torch/utils/checkpoint.py", line 579, in checkpoint_sequential
    input = checkpoint(
  File "/home/mohamed/anaconda3/lib/python3.8/site-packages/torch/_compile.py", line 31, in inner
    return disable_fn(*args, **kwargs)
  File "/home/mohamed/anaconda3/lib/python3.8/site-packages/torch/_dynamo/eval_frame.py", line 600, in _fn
    return fn(*args, **kwargs)
  File "/home/mohamed/anaconda3/lib/python3.8/site-packages/torch/utils/checkpoint.py", line 481, in checkpoint
    return CheckpointFunction.apply(function, preserve, *args)
  File "/home/mohamed/anaconda3/lib/python3.8/site-packages/torch/autograd/function.py", line 574, in apply
    return super().apply(*args, **kwargs)  # type: ignore[misc]
  File "/home/mohamed/anaconda3/lib/python3.8/site-packages/torch/utils/checkpoint.py", line 255, in forward
    outputs = run_function(*args)
  File "/home/mohamed/anaconda3/lib/python3.8/site-packages/torch/utils/checkpoint.py", line 566, in forward
    input = functions[j](input)
  File "/home/mohamed/anaconda3/lib/python3.8/site-packages/torch/nn/modules/module.py", line 1553, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/home/mohamed/anaconda3/lib/python3.8/site-packages/torch/nn/modules/module.py", line 1562, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/mohamed/anaconda3/lib/python3.8/site-packages/torch/nn/modules/container.py", line 219, in forward
    input = module(input)
  File "/home/mohamed/anaconda3/lib/python3.8/site-packages/torch/nn/modules/module.py", line 1553, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/home/mohamed/anaconda3/lib/python3.8/site-packages/torch/nn/modules/module.py", line 1562, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/mohamed/anaconda3/lib/python3.8/site-packages/torch/nn/modules/batchnorm.py", line 176, in forward
    return F.batch_norm(
  File "/home/mohamed/anaconda3/lib/python3.8/site-packages/torch/nn/functional.py", line 2512, in batch_norm
    return torch.batch_norm(
torch.OutOfMemoryError: CUDA out of memory. Tried to allocate 320.00 MiB. GPU 0 has a total capacity of 3.94 GiB of which 307.25 MiB is free. Including non-PyTorch memory, this process has 516.00 MiB memory in use. Process 10920 has 2.07 GiB memory in use. Of the allocated memory 448.05 MiB is allocated by PyTorch, and 13.95 MiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True to avoid fragmentation.  See documentation for Memory Management  (https://pytorch.org/docs/stable/notes/cuda.html#environment-variables)

2024-09-19 16:26:27,347 - ClientRunner - INFO - [identity=site-1, run=simulate_job, peer=simulator_server, peer_run=simulate_job, task_name=train_and_get_gradients, task_id=de6f9a8e-348f-4bb9-ae1d-ccf5c9f6385f]: try #1: sending task result to server
2024-09-19 16:26:27,347 - ClientRunner - INFO - [identity=site-1, run=simulate_job, peer=simulator_server, peer_run=simulate_job, task_name=train_and_get_gradients, task_id=de6f9a8e-348f-4bb9-ae1d-ccf5c9f6385f]: checking task ...
2024-09-19 16:26:27,348 - Cell - INFO - broadcast: channel='aux_communication', topic='__task_check__', targets=['server.simulate_job'], timeout=5.0
2024-09-19 16:26:27,357 - ClientRunner - INFO - [identity=site-1, run=simulate_job, peer=simulator_server, peer_run=simulate_job, task_name=train_and_get_gradients, task_id=de6f9a8e-348f-4bb9-ae1d-ccf5c9f6385f]: start to send task result to server
2024-09-19 16:26:27,358 - FederatedClient - INFO - Starting to push execute result.
2024-09-19 16:26:27,363 - Communicator - INFO -  SubmitUpdate size: 579B (579 Bytes). time: 0.005005 seconds
2024-09-19 16:26:27,363 - ClientRunner - INFO - [identity=site-1, run=simulate_job, peer=simulator_server, peer_run=simulate_job, task_name=train_and_get_gradients, task_id=de6f9a8e-348f-4bb9-ae1d-ccf5c9f6385f]: task result sent to server
2024-09-19 16:26:27,364 - ClientTaskWorker - INFO - Finished one task run for client: site-1 interval: 2 task_processed: True
2024-09-19 16:26:29,373 - FederatedClient - INFO - pull_task completed. Task name:__end_run__ Status:True 
2024-09-19 16:26:29,373 - ClientRunner - INFO - [identity=site-1, run=simulate_job, peer=simulator_server, peer_run=simulate_job]: server asked to end the run
2024-09-19 16:26:29,373 - ClientRunner - INFO - [identity=site-1, run=simulate_job]: started end-run events sequence
2024-09-19 16:26:29,374 - ClientRunner - INFO - [identity=site-1, run=simulate_job]: ABOUT_TO_END_RUN fired
2024-09-19 16:26:29,374 - ClientRunner - INFO - [identity=site-1, run=simulate_job]: Firing CHECK_END_RUN_READINESS ...
2024-09-19 16:26:29,375 - ClientRunner - INFO - [identity=site-1, run=simulate_job]: END_RUN fired
2024-09-19 16:26:29,375 - ClientTaskWorker - INFO - End the Simulator run.
2024-09-19 16:26:29,418 - ClientTaskWorker - INFO - Clean up ClientRunner for : site-1 
2024-09-19 16:26:29,420 - nvflare.fuel.f3.sfm.conn_manager - INFO - Connection [CN00002 Not Connected] is closed PID: 10921
